version: '3.8'

services:
  litellm:
    container_name: lexi-litellm
    image: ghcr.io/berriai/litellm:main-latest
    ports:
      - "8000:8000"
    volumes:
      - ./litellm/litellm-config.yaml:/app/config.yaml
    command: ["--config", "/app/config.yaml", "--port", "8000", "--num_workers", "8"]
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      UI_USERNAME: ${LITELLM_UI_USERNAME}
      UI_PASSWORD: ${LITELLM_UI_PASSWORD}
      LITELLM_LOG: ${LITELLM_LOG}
      DATABASE_URL: "postgresql://${LEXI_POSTGRES_USER}:${LEXI_POSTGRES_PASSWORD}@postgres:5432/${LEXI_POSTGRES_DB}"

  postgres:
    image: postgres:latest
    container_name: lexi-postgres
    environment:
      POSTGRES_USER: ${LEXI_POSTGRES_USER}
      POSTGRES_PASSWORD: ${LEXI_POSTGRES_PASSWORD}
      POSTGRES_DB: ${LEXI_POSTGRES_DB}
    volumes:
      - lexi_postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  weaviate:
    container_name: lexi-weaviate
    image: semitechnologies/weaviate:latest
    ports:
      - 8080:8080
      - 3000:8080
      - 50051:50051  # gRPC calls
    volumes:
      - lexi_weaviate_data:/var/lib/weaviate
    environment:
      OPENAI_APIKEY: ${OPENAI_API_KEY}
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'
      ENABLE_MODULES: 'text2vec-openai, generative-openai, qna-openai, text2vec-cohere'
      CLUSTER_HOSTNAME: 'node1'
    restart: on-failure
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=3", "--spider", "http://localhost:8080/v1/.well-known/ready"]
      interval: 10s
      timeout: 5s
      retries: 5

  verba:
    container_name: lexi-verba
    build:
      context: ./verba
      dockerfile: Dockerfile
    ports:
      - 8001:8000
    environment:
      WEAVIATE_URL_VERBA: ${VERBA_WEAVIATE_URL_VERBA}
      OPENAI_API_KEY: ${VERBA_OPENAI_API_KEY}
      # OPENAI_BASE_URL: ${VERBA_OPENAI_BASE_URL} # LiteLLM as the backend for Verba
      OPENAI_MODEL: ${VERBA_OPENAI_MODEL}
    volumes:
      - ./data:/data/
    depends_on:
      weaviate:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=3", "--spider", "http://localhost:8000"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 10s

  front-page:
    container_name: lexi-front-page
    image: nginx:latest
    volumes:
      - ./nginx/index.html:/usr/share/nginx/html/index.html
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
    ports:
      - 80:80
    restart: always


volumes:
  lexi_weaviate_data: {}
  lexi_postgres_data: {}
