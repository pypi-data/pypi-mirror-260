import{u as t,M as e,k as s,h as a,J as r,o as i,a as n,F as l,q as c,f as h,T as o,K as u,g as p,z as _}from"./index-DdDMmZ4g.js";import{C as d}from"./ChartsContainer-BvOYFy5L.js";import"./SLLoading-CJAmM2Mj.js";const m={key:0,class:"bg-higher min-h-[calc(100vh-163px)]"},g={key:0,class:"font-semibold pt-5 text-center"},M={__name:"ChartPage",setup(M){const v=t(),f=e(),b=o(),q=[...v.colors];q.getSeriesColor=(t,e)=>q[e],u("colors",q);let S=new Map,w=[];const R=s([]),k=s("initing");(async function(){const{data:t}=await a.get(`/experiment/${f.id}/chart`);E(t)})().then((()=>{C.start(),k.value="success"}));const x=t=>{const e=[];return t.charts.forEach((t=>{e.push(w[S.get(t)])})),e},E=t=>{w=t.charts||[],R.value=t.namespaces||[];const e=w.map((t=>(t._cid=D(t.id),C.addSource(t.source),t.id)));let s=!1;const a=R.value;R.value.forEach((t=>{s=!1,t.charts.forEach((t=>{for(let a=0;a<e.length;a++){const r=e[a];if(r===t){s=!0,S.set(r,a);break}}if(!s)throw new Error("Charts and groups cannot correspond.")}))})),R.value=a};class I{constructor(){this._map=new Map}canRequest(t){return!this._map.has(t)||"success"===this._map.get(t)}setPending(t){this._map.set(t,"pending")}setSuccess(t){this._map.set(t,"success")}setError(t){this._map.set(t,"error")}get(t){return this._map.get(t)}}class ${constructor(){this._map=new Map,this._intervalMap=new Map,this._callbackMap=new Map}setInterval(t,e,s=void 0){if(void 0===e)return;if(!s&&!this._callbackMap.get(t))return;let a=1e3;if(e<100)a=1e3;else if(e<500)a=1e3;else if(e<1e3)a=2e3;else{const t=Math.floor((e-1e3)/500);a=Math.min(8e3,2e3+1e3*t)}this._intervalMap.get(t)!==a&&(this.clear(t),s=s||this._callbackMap.get(t),this._map.set(t,setInterval(s,a)),this._callbackMap.set(t,s),this._intervalMap.set(t,a))}clear(t){const e=this._map.get(t);e&&clearInterval(e),this._map.delete(t),this._intervalMap.delete(t),this._callbackMap.delete(t)}clearAll(){this._map.forEach((t=>{clearInterval(t)})),this._map.clear(),this._intervalMap.clear()}}const C=new class{constructor(){this._sources=new Set,this._sourceMap=new Map,this._distributeMap=new Map,this._experiment_id=f.id,this.timer=null,this._timerMap=new $,this._intervalMap=new Map,this._request=new I,this._started=!1}setSourceData(t,e,s){e&&this._sourceMap.set(t,e);const a=this._distributeMap.get(t);if(!a)return this.setRequestStatus(t,s);Promise.all(Array.from(a.values()).map((a=>a(t,e,s)))).then((()=>{var a;this.setRequestStatus(t,s),this._timerMap.setInterval(t,null==(a=null==e?void 0:e.list)?void 0:a.length)}))}addSource(t){(t=t||[]).map((t=>{if(!this._started)return this._sources.add(t);this._sources.has(t)||(this._sources.add(t),this._getTagRequestInterval(t))}))}start(){const t=[];this._sources.forEach((e=>{t.push(this._getSoureceData(e))})),Promise.all(t).then((()=>{f.isRunning&&(this._sources.forEach((t=>{this._getTagRequestInterval(t)})),this._started=!0)}))}_getTagRequestInterval(t){var e;this._timerMap.setInterval(t,(null==(e=this._sourceMap.get(t))?void 0:e.list.length)||0,(()=>{f.charts&&E(f.charts),Number(this._experiment_id)===Number(b.params.experimentId)?(this._getSoureceData(t),f.isRunning||this._timerMap.clearAll()):this._timerMap.clearAll()}))}_getSoureceData(t){if(this._request.canRequest(t))return this._request.setPending(t),a.get(`/experiment/${this._experiment_id}/tag/${t}`).then((e=>{this.setSourceData(t,e.data,null)})).catch((e=>{this.setSourceData(t,null,e)}))}setRequestStatus(t,e){e?this._request.setError(t):this._request.setSuccess(t)}$on(t,e,s){(t=t||[]).map((t=>{const a=this._distributeMap.get(t);return a?a.set(e,s):this._distributeMap.set(t,new Map([[e,s]])),this._request.canRequest(t)?this._getSoureceData(t):"error"===this._request.get(t)?s(t,null,!0):void 0}))}$off(t,e){(null==this?void 0:this._distributeMap)&&(t=t||[]).map((t=>{const s=this._distributeMap.get(t);s&&s.delete(e)}))}delete(){this._timerMap.clearAll()}};u("$on",((t,e,s)=>C.$on(t,e,s))),u("$off",((t,e)=>C.$off(t,e))),r((()=>{C.delete()}));const D=t=>t;return(t,e)=>"success"===k.value?(i(),n("div",m,[(i(!0),n(l,null,c(R.value,(t=>{return i(),p(d,{key:t.name,label:(e=t.name,"default"===e?_("common.chart.label.default"):e),charts:x(t)},null,8,["label","charts"]);var e})),128)),0===R.value.length?(i(),n("p",g,"Empty Chart")):h("",!0)])):h("",!0)}};export{M as default};
