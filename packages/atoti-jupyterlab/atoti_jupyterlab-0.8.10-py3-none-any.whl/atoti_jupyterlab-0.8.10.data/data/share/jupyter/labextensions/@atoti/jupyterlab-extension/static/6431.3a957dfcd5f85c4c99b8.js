"use strict";(self.webpackChunk_atoti_jupyterlab_extension=self.webpackChunk_atoti_jupyterlab_extension||[]).push([[6431],{26431:(e,t,r)=>{r.r(t),r.d(t,{canOpenDrillthroughOnSelection:()=>v,getDrillthroughWidgetFilters:()=>Y,pluginMenuItemOpenDrillthrough:()=>ee});var o=r(17967),n=r(77026),l=r(66029),s=r(93481),a=r(56507),i=r(14690),u=r(63342),d=r(65523),c=r(46533),m=r(67010),h=r(5501),p=r(69673),f=r(85578);const g={int:"numeric",double:"numeric",long:"numeric",String:"regular",Object:"regular",LocalDate:"date",LocalDateTime:"date"};var y=r(44841);function v(e){return void 0!==e&&!(e.axes&&e.axes.length>0)&&void 0!==e.cells&&1===e.cells.length&&void 0!==e.cells[0].value}var b=r(79988),C=r(38674),x=r(14618),w=(r(53804),r(28338),r(31735),r(72826),r(85774),r(38664),r(9768),r(33398),r(76713),r(80352),r(58484),r(29309),r(19078));r(65611),r(84202),r(15326),r(30980);var S=r(53927),D=r(5957),I=r(70506),O=r(41234),N=r(40089),M=r(89038),E=r(27041),q=r(41144),R=r(28371);const F=(0,l.forwardRef)(((e,t)=>{const r=e.sort?.orderMode,n=e.sort?.drillthroughColumnUniqueName,l=e.value===n&&r,s=l&&"ASC"===r?f.IconNumericAscendingOrder:l&&"DESC"===r?f.IconNumericDescendingOrder:void 0;return(0,o.BX)("div",{ref:t,style:{display:"flex",alignItems:"center",...e.style},children:[(0,o.tZ)("span",{style:{textOverflow:"ellipsis",overflow:"hidden",maxWidth:`calc(100% - ${l?"18px":"0px"})`,...!e.wrapText&&{whiteSpace:"nowrap"}},children:e.caption}),s?(0,o.tZ)(s,{onClick:e.onSortChanged,style:{cursor:"pointer",marginLeft:"auto",height:"100%"}}):(0,o.tZ)("div",{style:{height:"100%",marginLeft:6}})]})}));F.displayName="DefaultDrillthroughHeaderCell";const W=(0,R.f)(F),k=(0,l.forwardRef)(((e,t)=>{const{caption:r,columnIndex:n,headerValues:s,isRowFrozen:a,widgetState:i}=e,d=a,c=s?.[n]?.name,m=c&&i.style?.measures?.[c]?.justifyContent,h=(0,l.useMemo)((()=>m?{...e.style,justifyContent:m}:e.style),[e.style,m]),[p]=(0,u.y)("table.tooltips");if(d)return(0,o.tZ)(W,{ref:t,...e});{const n=(i.style?.areTooltipsVisible??p)&&c&&r?[{left:c,right:r}]:void 0;return(0,o.tZ)(q.V,{ref:t,...e,style:h,tooltipContent:n})}}));k.displayName="DefaultDrillthroughCell";const B=(0,l.memo)(k);var Z=r(58736),j=r(54935);const L=({style:e})=>{const t=(0,j.Fg)();return(0,o.tZ)("div",{style:e,children:(0,o.tZ)("div",{css:{display:"flex",overflow:"hidden"},children:(0,n.range)(4).map((e=>(0,o.BX)("div",{children:[(0,o.tZ)("div",{css:Z.css`
                height: 28px;
                overflow: hidden;
                position: relative;
                width: 120px;
                border-right: 1px solid ${t.cellBorderColor};
              `,children:(0,o.tZ)("div",{css:Z.css`
                  padding: 4px 4px 3px;
                `})}),(0,o.tZ)("div",{css:Z.css`
                height: 196px;
                position: relative;
                border-top: 1px solid ${t.cellBorderColor};
                border-right: 1px solid ${t.cellBorderColor};
              `,children:(0,n.range)(7).map((e=>(0,o.tZ)("div",{css:Z.css`
                    font-size: 12px;
                    height: 28px;
                    left: 0px;
                    padding: 4px 4px 3px;
                    position: absolute;
                    top: ${28*e}px;
                    width: 120px;
                    overflow: hidden;
                    background-color: ${e%2==1?t.alternateCellBackgroundColor:"transparent"};
                    border-right: 1px solid ${t.cellBorderColor};
                  `},e)))})]},e)))})})};var $=r(83195),K=r(40719);function T(e,t){const{headers:r,rows:o}=t,n=new Map,l={};e.forEach((({columnHeader:e,body:t})=>{if(t)for(let e=t.rows.from;e<=t.rows.to;e++)for(let l=t.columns.from;l<=t.columns.to;l++){let t=n.get(r[l]);t||(t={},n.set(r[l],t)),t[e]=o[e][l]}e&&r.slice(e.columns.from,e.columns.to+1).forEach(((t,r)=>{l[e.columns.from+r]=t}))}));const s=[];for(const e of n.entries()){const[t,r]=e;s.push({header:t,cells:Object.keys(r).map((e=>parseInt(e))).sort().map((e=>r[e]))})}return{headers:Object.keys(l).map((e=>parseInt(e))).sort().map((e=>l[e])),columns:s}}var A=r(27860),z=r.n(A),P=r(97811);const Q=e=>e,_=(0,y.withLoadingOverlay)((0,y.withoutIrrelevantRenders)((e=>{const{queryResult:t,widgetState:r,style:a,onChange:c,onSelectionChange:m}=e,{widgetKey:h,columnWidths:p,sort:f}=r,g=r.style?.measures,[v]=(0,u.y)("table.headers.wrap"),b=r.style?.wrapHeaders??v;(0,w.useCallOnLoadedAfterFirstProperRender)(e);const{locale:C}=(0,s.useIntl)(),{cube:q,serverKey:R}=(0,y.useCube)(r),[F]=(0,d.o)(R,q.name),[W]=(0,I.useWidgetPlugins)([h]),[k]=(0,D.Nw)([W.cellStyle]),[Z]=(0,S.J6)([W?.cell]),j=(0,l.useCallback)((k?.withCellStyle??Q)(Z??B),[k]);j.displayName="DrillthroughCell";const A=t.data,{cells:_,headers:H}=(0,l.useMemo)((()=>A&&r.query.mdx&&F?((e,t,r)=>{const o=((e,t,r)=>{const o={};return(e.columns??[]).forEach(((e,n)=>{const l=(0,$.G)(e)?e.arguments[0]:e;if(!(0,K.a)(l)||void 0===t.find((e=>e.name===l.identifiers[0].value)))return;const s=l.identifiers[0].value;if(!r.some((({name:e})=>e===s)))return;o[s]||(o[s]={valueIndex:-1});const a=(0,$.G)(e)&&e.name.toLowerCase();"membervalue"!==a&&a?"caption"===a&&(o[s].captionIndex=n):o[s].valueIndex=n})),o})(e,t.headers,r);if((0,n.isEqual)(o,{}))return{cells:void 0,headers:void 0};const l=[];return Object.values(o).forEach((({captionIndex:e,valueIndex:r})=>{const o=t.headers[r];if(o){const r=void 0!==e?t.headers[e].caption:o.caption;l.push({...o,caption:r})}})),{cells:t.rows.map((e=>Object.values(o).map((({captionIndex:t,valueIndex:r})=>{const o=e[r];return{caption:void 0!==t?`${e[t]}`:"object"==typeof o?JSON.stringify(o):`${o}`,value:"number"==typeof o?o:JSON.stringify(o)}})))),headers:l}})(r.query.mdx,A?.result,F):{cells:void 0,headers:void 0}),[r.query,A,F]),V=(0,l.useMemo)((()=>(H||[]).map((({caption:e})=>({value:e,caption:e})))),[H]),U=(0,l.useMemo)((()=>{if(_&&f){const e=V.findIndex((e=>e?.caption===f.drillthroughColumnUniqueName));if(e>-1)return(0,n.orderBy)(_,[t=>t[e].value],["ASC"===f.orderMode?"asc":"desc"])}}),[_,f,V])??_,J=(0,l.useMemo)((()=>{const e=g&&U?(({bodyCells:e,columnsStyle:t,headerCells:r,locale:o})=>{const n=r.map(((e,t)=>({styledColumnIndex:t,value:e?.value}))).filter((({value:e})=>t[String(e)]));return(0,x.produce)(e,(e=>{e?.forEach((e=>{Object.values(n).forEach((({styledColumnIndex:r,value:n})=>{if(!n)return;const l=e[r],s=t[n],a=s.dateFormat?z()(l.value,{locale:o}).format(s.dateFormat):(0,P.m)({locale:o,measureStyle:s,value:Number(l.value),valueFormattedByActivePivot:l.caption});e[r]={caption:a,value:l.value}}))}))}))})({bodyCells:U,columnsStyle:g,headerCells:V,locale:C}):U;return[V,...e??[]]}),[V,g,U,C]),G=(0,l.useMemo)((()=>p&&H?Object.entries(p).reduce(((e,[t,r])=>{const o=H.findIndex((e=>e?.caption===t));return-1!==o?{...e,[o]:r}:e}),{}):void 0),[H,p]);if(!t.isLoading&&t.error){if((0,i.isQueryErrorOfType)(t.error,"QueryTimeoutException"))throw new i.QueryTimeoutError(t.error);throw new i.MdxError(t.error)}const X=(0,l.useCallback)((()=>{c({...r,sort:{...f,orderMode:"ASC"===f.orderMode?"DESC":"ASC"}})}),[r,f,c]),Y=(0,w.useCurriedComponent)(j,{headerValues:H||[],onSortChanged:X,sort:f,widgetState:r});Y.displayName="DrillthroughTableCell";const ee=(0,l.useRef)([]),te=(0,l.useRef)(void 0);(0,l.useEffect)((()=>{if(H&&U&&m){const e=te.current,t=T(ee.current,{headers:H,rows:U.map((e=>e.map((e=>e.value))))});(0,n.isEqual)(t,e)||(te.current=t,m(t))}}),[H,m,U]);const re=H?e=>{c({...r,columnWidths:{...p,...Object.entries(e).reduce(((e,[t,r])=>({...e,[H[parseInt(t)].caption]:r})),{})}})}:void 0,oe=H&&U?e=>{if(m){ee.current=e;const t=T(e,{headers:H,rows:U.map((e=>e.map((e=>e.value))))});te.current=t,m(t)}}:void 0,ne=(0,l.useRef)(null);return(0,l.useEffect)((()=>{async function e(e){if(!U||document.activeElement!==ne.current)return;e.preventDefault();const t=(0,O.r)(ee.current,{numberOfColumnsInBody:H?.length??0,numberOfFrozenColumns:0,numberOfFrozenRows:1,numberOfRowsInBody:U.length});if(t.length>0){const r=t[0],o=(0,N.p)(r.columnHeader,(e=>`${V[e]?.value}`)),n=(0,N.p)(r.body,((e,t)=>`${U[t][e].value}`)),l=(0,M.i)({header:o,body:n});e.clipboardData?.setData("text/plain",l["text/plain"]),e.clipboardData?.setData("text/html",l["text/html"])}}return document.addEventListener("copy",e),()=>{document.removeEventListener("copy",e)}}),[U,V,H?.length]),J?(0,o.tZ)(E.i,{cells:J,style:a,numberOfFrozenRows:1,Cell:Y,columnWidths:G,onColumnsResized:re,onSelectionChanged:oe,size:r.style?.size,wrapHeaders:b}):(0,o.tZ)(L,{style:e.style})})));r(9440),r(79549),r(73241),r(5637),r(36176),r(4259);const H=()=>{},V={query:{updateMode:"once"},widgetKey:"drillthrough-table"},U=(J=(0,y.withWidgetQueryErrorBoundary)(_),(0,l.memo)((e=>{const{serverKey:t,cube:r}=(0,y.useCube)(e.widgetState),{widgetState:n,queryId:l,isDeferred:s}=e,{dashboardState:a,pageKey:i}=(0,y.isWidgetInDashboard)(e)?e:{},u=(0,y.useWidgetQueryResult)({serverKey:t,queryId:l,widgetState:n,dashboardState:a,pageKey:i,cube:r,isDeferred:s});return(0,o.tZ)(J,{...e,queryResult:u,onQueryRangesChanged:H})})).displayName=`withDrillthroughQueryResult(${J.displayName})`,C.A,f.IconBusinessDrillthrough,V);var J,G=r(97700);function X(e,t){const{dimensionName:r,hierarchyName:o}=e;return t.some((e=>(0,G.I)(e,{dimensionName:r,hierarchyName:o})))}function Y({sourceWidgetFilters:e,tuple:t,cube:r}){return[...(e||[]).filter((e=>!X(e,t))),...t.map((({dimensionName:e,hierarchyName:t,namePath:r})=>({type:"members",dimensionName:e,hierarchyName:t,members:[r]})))]}const ee={key:"open-drillthrough",useMenuItem:e=>{const{selection:t,widgetState:r}=e,{cube:C,serverKey:x}=(0,y.useCube)(r),{formatMessage:w}=(0,s.useIntl)(),S=(0,c.T)(),D=(0,l.useMemo)((()=>{if(v(t))return t.cells[0].tuple.filter((e=>"Measures"===e.dimensionName||!(0,i.isTotal)((0,p._)(e,C),e)))}),[C,t]),I=(0,l.useMemo)((()=>{if(D){const e=D.filter((e=>"Measures"!==e.dimensionName));return w({id:"aui.plugins.menu-item.open-drillthrough.openDrillthrough"},{member:e.length>0?(0,i.getTupleCaption)(e,{captionForTotals:w({id:"aui.total"}),cube:C,separator:", ",hasOnlyCaptionForLeafLevels:!0}):void 0})}}),[w,D,C]),[O]=(0,u.y)("drillthrough.defaultSelectedColumns"),[N]=(0,d.o)(x,C.name),M=(0,l.useMemo)((()=>{const e=(t=N??[],(0,n.mapValues)((0,n.groupBy)(t,(({type:e})=>g[e]??"regular")),(e=>(0,n.sortBy)(e,(e=>e.name.toLowerCase())))));var t;return(0,n.flatten)(["numeric","regular","date"].map((t=>e[t]??[])))}),[N]),E=(0,l.useCallback)((async()=>{if(S&&I&&D&&(0,a.F)(e)){const t=(0,m.A)(e.dashboardState.pagesOrder),o=e.dashboardState.pagesOrder.indexOf(S),l=e.dashboardState.pages[S];if(void 0===r.query.mdx)return;const s=function({name:e,sourceWidget:t,sourceWidgetPage:r,tuple:o,drillthroughColumns:l,defaultSelectedColumns:s,cube:a}){const i=Y({sourceWidgetFilters:t.filters,tuple:o,cube:a}),u=(0,n.map)(l,"name"),d=s[a.name]?(0,n.intersection)(u,s[a.name]):u,c={mdx:(0,b.r)((0,y.getDefaultMdxDrillthrough)(a.name),{drillthroughColumnUniqueNames:d})};t.query.mdx&&t.query.mdx.withClause&&(c.mdx.select.withClause=t.query.mdx.withClause);const m=(r.filters||[]).filter((e=>!X(e,o)));return{name:e,content:{0:{...U,query:c,serverKey:t.serverKey,initialCubeName:a.name,filters:i}},layout:{direction:"column",children:[{leafKey:"0",size:1}]},filters:m}}({name:I,sourceWidget:r,sourceWidgetPage:l,tuple:D,drillthroughColumns:M,defaultSelectedColumns:O,cube:C}),a=(0,h.W)(e.dashboardState,{page:s,key:t,index:o+1});e.onDashboardChange(a),e.onActivePageChange(t)}}),[S,C,I,e,D,r,O,M]);if((0,a.F)(e)&&D&&r.query.mdx)return{icon:(0,o.tZ)(f.IconDrillthrough,{}),label:I,onClick:E}},translations:{"en-US":{openDrillthrough:"Drillthrough {member, select,\n           undefined {}\n           other {on {member}}\n          }"},"fr-FR":{openDrillthrough:"Drillthrough {member, select,\n           undefined {}\n           other {sur {member}}\n          }"}}}}}]);