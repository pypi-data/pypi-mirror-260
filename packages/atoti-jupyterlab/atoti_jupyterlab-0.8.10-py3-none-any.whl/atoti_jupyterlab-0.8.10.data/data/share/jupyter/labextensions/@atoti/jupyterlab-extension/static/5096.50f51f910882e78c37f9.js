"use strict";(self.webpackChunk_atoti_jupyterlab_extension=self.webpackChunk_atoti_jupyterlab_extension||[]).push([[5096],{65096:(e,t,l)=>{l.r(t),l.d(t,{default:()=>B});var n=l(17967),r=l(77026),o=l(66029),i=l(14690),a=l(34220),s=l(93481),c=l(78227),u=l(18201);function d({captionForTotals:e,cube:t,mapping:l,tuple:n,style:r}){return n.map((n=>(0,u.h)({captionForTotals:e,cube:t,mapping:l,member:n,style:r}))).join(" ")}var p=l(58736);const m=e=>{const t=(0,o.useMemo)((()=>o.Children.toArray(e.children).reduce(((t,l,n)=>{const r=Math.floor(n/e.numberOfColumns),o=t[r]??[];return t[r]=[...o,l],t}),[])),[e.children,e.numberOfColumns]);return(0,n.tZ)("div",{style:e.containerStyle,css:{paddingBottom:2,paddingRight:2,width:"100%",height:"100%"},children:(0,n.tZ)("div",{css:{width:"100%",height:"100%",overflow:"auto"},children:(0,n.tZ)("table",{css:p.css`
            border-spacing: 20px 10px;
            border-collapse: separate !important;
            width: 100%;
          `,children:(0,n.tZ)("tbody",{children:t.map(((e,t)=>(0,n.tZ)("tr",{children:e.map(((e,t)=>(0,n.tZ)("td",{children:e},t)))},t)))})})})})};var f=l(97811),h=l(64421),g=l(54935),y=l(22383),C=l(19078);const b=e=>{const t=(0,g.Fg)(),l=(0,y.T)(),r={color:t.textColor,paddingLeft:e.horizontalPadding,paddingRight:e.horizontalPadding,height:25},i={...r,border:"1px solid transparent",background:"transparent",":hover":{border:`1px solid  ${t.primaryColor}`,borderRadius:3},":focus":{outlineColor:t.primaryColor}},[a,s]=(0,o.useState)(e.title);return(0,o.useEffect)((()=>{s(e.title)}),[e.title]),l?(0,n.tZ)("div",{css:r,children:a}):(0,n.tZ)(C.AutoSizedInput,{isStrictlySized:!1,inputCss:i,value:a||"",onChange:s,onBlur:()=>{e.onTitleChange?.(a)}})},v=({differenceCell:e,referenceValue:t,measureStyle:l,isDifferenceInPercentage:n})=>{const r=Number(e?.value);return isNaN(r)||n&&isNaN(t)?"N/A":`${r>0?"+":""}${n?(0,f.m)({value:r/Math.abs(t),valueFormattedByActivePivot:"N/A",measureStyle:{numberFormat:"percentage",numberOfDecimals:2}}):(0,f.m)({value:r,valueFormattedByActivePivot:e?.formattedValue??"N/A",measureStyle:l})}`},S=({difference:e,referenceValue:t,theme:l,isDifferenceInPercentage:n})=>isNaN(e)||0===e||n&&isNaN(t)?l.textColor:e>0?l.successColor:l.errorColor,x=e=>{const t=(0,g.Fg)(),{formatMessage:l}=(0,s.useIntl)(),{onTitleChange:a,title:c,isTime:u,tuple:d,onSelect:p,isSelected:m,differenceCell:y,style:C}=e,x=Number(e.referenceCell?.value),w=m?`${t.selectionOverlayColor}`:"none",M=(0,o.useMemo)((()=>{const e=d.find((({dimensionName:e})=>"Measures"===e))?.namePath[0];return e?C?.measures?.[e]:void 0}),[d,C?.measures]),I=e.comparedCell&&(0,r.isNumber)(e.comparedCell.value)&&e.comparedCell.value<0,[[T,N],[Z,O]]=(0,o.useMemo)((()=>[e.referenceCell,e.comparedCell].map((e=>[(0,f.m)({value:Number(e?.value??0),valueFormattedByActivePivot:e?.formattedValue??"N/A",measureStyle:M}),(0,h.d)({measureStyle:M,value:e?.value})]))),[M,e.referenceCell,e.comparedCell]);return(0,n.BX)("div",{style:{background:w,height:83,display:"flex",alignItems:"flex-end",padding:"0px 2px"},onMouseDown:e=>{(0===e.button||!m&&2===e.button)&&p({cell:y,tuple:d,isSelected:m})},children:[(0,n.tZ)("span",{style:{borderLeft:`3px solid ${t.primaryColor}`,height:75}}),(0,n.BX)("div",{style:{display:"flex",paddingLeft:5,flexDirection:"column"},children:[(0,n.tZ)(b,{title:c,onTitleChange:e=>{const t=(0,i.getTupleKey)(d);a?.({tupleKey:t,title:e})},horizontalPadding:"2px"}),(0,n.BX)("div",{style:{display:"flex"},children:[(0,n.BX)("div",{style:{display:"flex",flexDirection:"column",justifyContent:"space-between",whiteSpace:"nowrap",paddingLeft:2},children:[(0,n.tZ)("span",{style:{fontWeight:600,fontSize:20,lineHeight:1.5,color:O.backgroundColor||(I?t.errorColor:void 0)},children:Z}),u?l({id:"aui.plugins.widget.kpi.on"},{value:e.comparedMemberCaption}):e.comparedMemberCaption]}),(0,n.tZ)("span",{style:{margin:"8px 10px 3px",borderLeft:`1px solid ${t.grayScale[4]}`}}),(0,n.BX)("div",{style:{paddingTop:3,display:"flex",justifyContent:"space-around",flexDirection:"column",whiteSpace:"nowrap"},children:[(0,n.tZ)("span",{style:{color:S({difference:Number(e.differenceCell?.value),referenceValue:x,theme:t,isDifferenceInPercentage:C?.isDifferenceInPercentage}),fontWeight:500},children:v({differenceCell:e.differenceCell,measureStyle:M,referenceValue:x,isDifferenceInPercentage:C?.isDifferenceInPercentage})}),(0,n.tZ)("span",{style:{fontSize:9,color:N.backgroundColor},children:l({id:"aui.plugins.widget.kpi.vs"},{value:T})}),u?l({id:"aui.plugins.widget.kpi.on"},{value:e.referenceMemberCaption}):e.referenceMemberCaption]})]})]})]})},w=(e,t)=>{const l=[];return e&&t&&l.push({tuple:t,value:e.value}),{axes:[],cells:l}};var M=l(38785);function I(e,t){const{cells:l,numberOfColumns:n,numberOfRows:r}=(0,o.useMemo)((()=>{let t,l;for(let n=0;n<e.axes.length;n++){const r=e.axes[n];if(r.id===i.axisIds.columns?l=r:r.id===i.axisIds.rows&&(t=r),void 0!==t&&void 0!==l)break}const n=l?(0,i.getAxisLength)(l):1,r=t?(0,i.getAxisLength)(t):1,o=new Array(n*r).fill(null);return e.cells.forEach((e=>{o[e.ordinal]=e})),{numberOfColumns:n,numberOfRows:r,cells:o}}),[e]),a=(0,o.useMemo)((()=>(0,i.getHierarchyIndicesInCellSet)(e,{axisNames:["ROWS","COLUMNS"]})),[e]);return{cells:l,numberOfColumns:n,numberOfRows:r,cube:(0,o.useMemo)((()=>{const l=e.cube;return(0,M.s)(t,l)}),[e,t]),hierarchyIndicesInCellSet:a}}const T=["referenceCell","comparedCell","differenceCell"],N=e=>{const{formatMessage:t}=(0,s.useIntl)(),{cube:l,hierarchyIndicesInCellSet:a,numberOfColumns:p,numberOfRows:f}=I(e.data,e.dataModel),h=e.data.axes.find((({id:e})=>e===i.axisIds.pages));if(!h)throw new Error("A comparison was defined in the KPI widget state, but no corresponding data was found (no PAGES axis in the cellset).");const g=h.positions.length,y=(0,c.F)(h.hierarchies[0].dimension,l),C=t({id:"aui.total"}),[b,v]=(0,o.useMemo)((()=>{const{dimension:t,hierarchy:n}=h.hierarchies[0],r=h.positions.map((([r])=>(0,u.h)({captionForTotals:C,cube:l,mapping:e.mapping,member:{dimensionName:t,hierarchyName:n,...r},style:e.style})));return 3===g?r:["N/A",r[0]]}),[C,l,g,h,e.mapping,e.style]),S=(0,o.useMemo)((()=>{const t={},n=p*f;return e.data.cells.forEach((r=>{const o=Math.floor(r.ordinal%n/p),s=r.ordinal%p,c=(0,i.getTuple)({columnIndex:s,rowIndex:o,hierarchyIndicesInCellSet:a,data:e.data});if(c){const o=(0,i.getTupleKey)(c),a=t[o]?.title||e.titles?.[o]||d({captionForTotals:C,cube:l,mapping:e.mapping,tuple:c,style:e.style}),s=Math.floor(r.ordinal/n),u=3===g?T[s]:s===g-1?"differenceCell":"comparedCell";t[o]={...t[o],[u]:r,title:a,tuple:c}}}),{}),t}),[C,l,a,p,f,g,e.data,e.titles,e.mapping,e.style]),{titles:M,onTitlesChange:N,onSelectionChange:Z}=e,O=({tupleKey:e,title:t})=>{N?.({...M,[e]:t})},[k,A]=(0,o.useState)({axes:[],cells:[]}),P=k.cells?.[0]?(0,i.getTupleKey)(k.cells[0].tuple):void 0,E=({cell:e,tuple:t,isSelected:l})=>{A(l?{axes:[],cells:[]}:w(e,t))};(0,o.useEffect)((()=>{Z?.(k)}),[k,Z]);const K=(0,r.map)(S,(({referenceCell:t,comparedCell:l,differenceCell:r,title:o,tuple:i},a)=>(0,n.tZ)(x,{comparedCell:l,comparedMemberCaption:v,isTime:"TIME"===y.type,differenceCell:r,title:o,onTitleChange:O,referenceCell:t,referenceMemberCaption:b,tuple:i,onSelect:E,isSelected:P===a,style:e.style},a)));return(0,n.tZ)(m,{numberOfColumns:p,containerStyle:e.containerStyle,children:K})};var Z=l(72702),O=l(46429);const k=e=>{const t=(0,g.Fg)(),{cell:l,tuple:r,tupleKey:i,onTitleChange:a,title:s,isSelected:c,onSelect:u,style:d}=e,m=(0,Z.E)(l?.properties),y=c&&m.backgroundColor?(0,O.$)(m.backgroundColor,t.selectionOverlayColor,.2):c?t.selectionOverlayColor:m.backgroundColor??"none",[C,v]=(0,o.useMemo)((()=>{const e=r.find((({dimensionName:e})=>"Measures"===e))?.namePath[0],t=e?d?.measures?.[e]:void 0;return[(0,f.m)({value:Number(l?.value),valueFormattedByActivePivot:l?.formattedValue??"N/A",measureStyle:t}),(0,h.d)({measureStyle:t,value:l?.value})]}),[r,d?.measures,l]);return(0,n.BX)("div",{css:p.css`
        padding-left: 6px;
        border-left: 3px solid ${t.primaryColor};
        white-space: nowrap;
      `,children:[(0,n.tZ)(b,{title:s,onTitleChange:e=>{a({title:e,tupleKey:i})},horizontalPadding:2}),(0,n.tZ)("div",{onMouseDown:e=>{(0===e.button||!c&&2===e.button)&&u({cell:l,tuple:r,isSelected:c})},css:{background:y,color:v.backgroundColor??m.color,fontSize:30,height:50,display:"flex",alignItems:"center",paddingLeft:2},children:C})]})},A=e=>{const{formatMessage:t}=(0,s.useIntl)(),{cells:l,numberOfColumns:r,cube:a}=I(e.data,e.dataModel),c=(0,o.useMemo)((()=>(0,i.getHierarchyIndicesInCellSet)(e.data)),[e.data]),{titles:u,onTitlesChange:p,onSelectionChange:f}=e,h=({tupleKey:e,title:t})=>{p?.({...u,[e]:t})},[g,y]=(0,o.useState)({axes:[],cells:[]}),C=g.cells?.[0]?(0,i.getTupleKey)(g.cells[0].tuple):void 0,b=({cell:e,tuple:t,isSelected:l})=>{y(l?{axes:[],cells:[]}:w(e,t))},v=t({id:"aui.total"}),S=(0,o.useMemo)((()=>{const t=[];return l.forEach(((l,n)=>{const o=Math.floor(n/r),s=n%r,p=(0,i.getTuple)({columnIndex:s,data:e.data,rowIndex:o,hierarchyIndicesInCellSet:c});if(p){const n=(0,i.getTupleKey)(p),r=a?d({captionForTotals:v,cube:a,mapping:e.mapping,tuple:p,style:e.style}):"",o=u?.[n]||r;t.push({cell:l,tuple:p,tupleKey:n,title:o})}})),t}),[l,a,e.data,c,r,u,v,e.mapping,e.style]);(0,o.useEffect)((()=>{f?.(g)}),[g,f]);const x=S.map((({cell:t,tuple:l,tupleKey:r,title:o},i)=>(0,n.tZ)(k,{cell:t,cellIndex:i,tuple:l,tupleKey:r,title:o,onTitleChange:h,onSelect:b,isSelected:C===r,style:e.style},i)));return(0,n.tZ)(m,{numberOfColumns:r,containerStyle:e.containerStyle,children:x})};var P=l(98496);const E=e=>{const{comparison:t,...l}=e;return(0,P.K)(e.comparison)?(0,n.tZ)(N,{comparison:t,...l}):(0,n.tZ)(A,{...l})};var K=l(44841),F=l(88369);const D=(0,o.memo)((e=>{(0,C.useCallOnLoadedAfterFirstProperRender)(e);const{queryResult:t,widgetState:l,onChange:s,onSelectionChange:c}=e,u=t.data,d=l.serverKey,p=(0,a.k)(d),m=l.titles,f=(0,o.useCallback)((e=>s((0,r.isEmpty)(e)?(0,r.omit)(l,"titles"):{...l,titles:e})),[l,s]);if(!t.isLoading&&t.error){if((0,i.isQueryErrorOfType)(t.error,"QueryTimeoutException"))throw new i.QueryTimeoutError(t.error);throw new i.MdxError(t.error)}if(!p||!u||(0,K.isMappingEmpty)(l.mapping)){const t=0===u?.cells.length;return(0,n.tZ)(F.A,{style:e.style,noData:t})}return(0,n.tZ)(E,{data:u,dataModel:p,titles:m,onTitlesChange:f,comparison:l.comparison,containerStyle:e.style,onSelectionChange:c,style:l.style,mapping:l.mapping})})),B=(0,K.withLoadingOverlay)((0,K.withoutIrrelevantRenders)(D))}}]);