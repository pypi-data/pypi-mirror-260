"use strict";(self.webpackChunk_atoti_jupyterlab_extension=self.webpackChunk_atoti_jupyterlab_extension||[]).push([[2843],{72843:(e,t,a)=>{a.r(t),a.d(t,{default:()=>T});var n=a(93388),s=a(14618),o=a(77026),i=a(66029),r=a(93481),l=a(56507),u=a(47764),c=a(5405),d=a(42921),y=a(75917);function p(e){return e.substring(5,e.length-1).split(",")}var m=a(65611),x=a(44841),f=a(28158),h=a(81292),g=a(9617);const v=e=>{const{formatMessage:t}=(0,r.useIntl)(),{onOk:a,onCancel:s,templatedName:o}=e,[l,u]=(0,i.useState)(""),[c,d]=(0,i.useState)(""),y=(e=>{const t=e.indexOf("$"),a=e.lastIndexOf("$");return e.substring(t,a+1)})(o),p=o.replace(y,l);return(0,n.BX)("div",{style:{width:400,display:"flex",flexDirection:"column"},children:[(0,n.BX)("div",{style:{flexGrow:1},children:[(0,n.tZ)(g.Input,{style:{marginTop:8},placeholder:y,value:l,onChange:e=>u(e.target.value)}),(0,n.tZ)(g.Input,{style:{marginTop:8},placeholder:"value",value:c,onChange:e=>d(e.target.value)})]}),(0,n.BX)("div",{css:h.css`
          height: 35px;
          display: flex;
          justify-content: flex-end;
          margin-top: 8px;
        `,children:[(0,n.tZ)(g.Button,{css:h.css`
            &.ant-btn {
              margin-right: 8px;
            }
          `,onClick:s,children:t({id:"aui.cancel"})}),(0,n.tZ)(g.Button,{onClick:()=>{a(p,c)},disabled:0===l.length||0===c.length||e.queryContext?.some((({key:e})=>e===p)),type:"primary",children:t({id:"aui.ok"})})]})]})},C=e=>{let t;const[a,s]=(0,i.useState)(null),o=t=>{isNaN(Number(t))&&"ALL"!==e.type||e.onValueChanged?.(t)};if((0,i.useEffect)((()=>{"BOOL"!==e.type&&"ENUM"!==e.type&&s(e.value)}),[e.type,e.value]),"BOOL"===e.type)t=(0,n.tZ)(g.Checkbox,{checked:"true"===e.value,disabled:e.isDisabled,onChange:()=>e.onValueChanged?.("true"===e.value?"false":"true")});else if(e.isDisabled)t=e.value;else if(e.type.startsWith("ENUM")){const a=p(e.type);t=(0,n.tZ)(g.Select,{value:e.value,size:"small",onChange:e.onValueChanged,disabled:e.isDisabled,children:a.map((e=>(0,n.tZ)(g.Select.Option,{value:e,children:e},e)))})}else t=(0,n.tZ)(g.Input,{value:a??"",onChange:e=>s(e.target.value),onBlur:e=>{o(e.target.value)},onPressEnter:e=>{o(e.currentTarget.value)},size:"small",disabled:e.isDisabled});return(0,n.BX)("div",{css:{display:"flex",marginRight:16},children:[(0,n.tZ)("div",{css:{flexGrow:1,whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden"},title:e.name,children:e.name}),(0,n.tZ)("div",{css:{textAlign:"right",flexGrow:1,flexShrink:1,marginLeft:10,whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden",minWidth:35},children:t})]},e.name)},b=["drillthrough.hiddencolumns","subcube"],N=["mdx.kpi","mdx.member","mdx.formatters","mdx.set","mdx.measureAlias","mdx.defaultmembers","user-authentication"],k=["dashboard","page","widget"],E=(e,{sectionName:t,pageKey:a,leafKey:n})=>{const s="dashboard"===t?e:"page"===t?(0,d.f)(e,a):(0,y.L)(e,a,n);if(!s)throw new Error(`Impossible to edit the ${t}'s query context, as its corresponding state was not found.`);return s},I=(e,t,a)=>{e.queryContext||(e.queryContext=[]),e.queryContext.splice(a,0,t)},K=({dashboardState:e,pageKey:t,leafKey:a,userQueryContext:n,sectionName:o,queryContextEntry:i,index:r})=>{let l=n,u=e;return"user"===o?l=(0,s.produce)(n,(e=>{e.splice(r,0,i)})):u=(0,s.produce)(e,(e=>{const n=E(e,{sectionName:o,pageKey:t,leafKey:a});I(n,i,r)})),[u,l]},O=(e,t)=>{if(!e.queryContext)return;const{queryContext:a}=e;a.splice(t,1),0===a.length&&delete e.queryContext},w=({dashboardState:e,pageKey:t,leafKey:a,userQueryContext:n,sectionName:o,index:i})=>{let r=n,l=e;return"user"===o?r=(0,s.produce)(n,(e=>{e.splice(i,1)})):l=(0,s.produce)(e,(e=>{const n=E(e,{sectionName:o,pageKey:t,leafKey:a});O(n,i)})),[l,r]},T=e=>{const{dashboardState:t,pageKey:a,leafKey:d,onDashboardChange:y}=(0,l.F)(e)?e:{},{cube:h,dataModel:g}=(0,x.useCube)(e.widgetState),{widgetState:T,onWidgetChange:S}=e,{formatMessage:q}=(0,r.useIntl)(),[Q,,]=(0,u.g)("canUseUserQueryContext");let R=k;Q&&(R=["user",...k]);const _=(0,x.useQueryContexts)(T,t,a),[,Z]=(0,c.X)("userQueryContext"),[B,D]=(0,i.useState)(),P=g.contextValues,V=(0,i.useCallback)((e=>{if(P[e])return P[e].type;const t=(0,o.findKey)(P,(({name:t})=>e.startsWith(t.replace(/\$.*\$$/,""))));return t?P[t].type:"ALL"}),[P]),L=(0,i.useMemo)((()=>{const e=Object.values(g.contextValues).filter((({name:e})=>!b.some((t=>e.startsWith(t))))),t=(0,o.groupBy)(e,(({category:e})=>e||"misc"));return Object.keys(t).map((e=>({caption:e,isFolder:!0,isActionable:!1,type:e,children:t[e].map((t=>{const a={type:"QUERY_CONTEXT_ENTRY",key:t.name};return{caption:t.name,type:e,isActionable:!0,isDisabled:R.every((e=>_[e]?.some((({key:e})=>e===t.name)))),dragItem:a}}))})))}),[g.contextValues,_,R]),U=(0,i.useMemo)((()=>{const e={};return e.default={placeholder:q({id:"aui.tool.queryContextEditor.noQueryContextEntries"}),caption:q({id:"aui.tool.queryContextEditor.defaultSection"}),tiles:Object.values(h.contextValues).filter((({name:e})=>N.every((t=>!e.startsWith(t)))&&b.every((t=>!e.startsWith(t))))).map((({name:e,value:t},a)=>{const s={key:e,value:t,fromPosition:{sectionName:"default",tileIndex:a},type:"QUERY_CONTEXT_ENTRY"};return{caption:(0,n.tZ)(C,{name:e,value:t,isDisabled:!0,type:V(e)}),dragItem:s,isDisabled:R.some((t=>_[t]?.some((({key:t})=>t===e)))),isRemovable:!1}}))},R.forEach((o=>{const i=_[o];e[o]={caption:q({id:`aui.tool.queryContextEditor.${o}Section`}),tiles:i?i.map((({key:e,value:i},r)=>{const l={key:e,value:i,fromPosition:{sectionName:o,tileIndex:r},type:"QUERY_CONTEXT_ENTRY"},u=R.slice(R.indexOf(o)+1).some((t=>_[t]?.some((t=>e===t.key))));return{caption:(0,n.tZ)(C,{name:e,value:i,type:V(e),isDisabled:u,onValueChanged:e=>{if(y&&t&&a&&d)if("user"===o){if(!_.user)return;const t=(0,s.produce)(_.user,(t=>{t[r].value=e}));Z(t)}else{const n=(0,s.produce)(t,(t=>{E(t,{leafKey:d,pageKey:a,sectionName:o}).queryContext[r].value=e}));y(n)}else{const t=(0,s.produce)(T,(t=>{t.queryContext[r].value=e}));S(t)}}}),isRemovable:!0,isDisabled:u,dragItem:l}})):[]}})),B&&e[B.sectionName].tiles.splice(B.tileIndex,0,{caption:B.key,dragItem:null}),e}),[B,V,h.contextValues,_,t,q,d,y,S,a,T,Z,R]),X=(0,i.useCallback)((({sectionName:e,tileIndex:n})=>{if(y&&t&&a&&d){const[s,o]=w({dashboardState:t,pageKey:a,leafKey:d,userQueryContext:_.user||[],sectionName:e,index:n});s!==t&&y(s),o!==_.user&&Z(o)}else{const e=(0,s.produce)(T,(e=>{O(e,n)}));S(e)}}),[t,d,y,a,_.user,T,S,Z]),Y=(0,i.useCallback)(((e,n,o)=>{const i=o??(_[e]?.length||0);if(-1!==n.indexOf("$"))D({sectionName:e,tileIndex:i,key:n});else{const o={key:n,value:((e,t)=>{if(!e)return"";const a=t[e.name];if(e.type.startsWith("ENUM"))return p(e.type)[0];switch(e.type){case"BOOL":return void 0!==a?a.value:"true";case"LONG":case"INTEGER":case"DOUBLE":return void 0!==a?a.value:"0";default:return a?.value||""}})(P[n],h.contextValues)};if(y&&t&&a&&d){const[n,s]=K({dashboardState:t,pageKey:a,leafKey:d,userQueryContext:_.user||[],sectionName:e,queryContextEntry:o,index:i});n!==t&&y(n),s!==_.user&&Z(s)}else{const e=(0,s.produce)(T,(e=>{I(e,o,i)}));S(e)}}}),[P,t,d,y,S,a,_,T,h.contextValues,Z]),M=(0,i.useCallback)((e=>{e.isActionable&&!_.widget?.some((({key:t})=>t===e.caption))&&Y("widget",e.caption)}),[Y,_]),A=(0,i.useCallback)(((e,n)=>{if(B){const o={key:e,value:n};if(y&&t&&a&&d){const[e,n]=K({dashboardState:t,pageKey:a,leafKey:d,userQueryContext:_.user||[],sectionName:B.sectionName,queryContextEntry:o,index:B.tileIndex});e!==t&&y(e),n!==_.user&&Z(n)}else{const e=(0,s.produce)(T,(e=>{I(e,o,B.tileIndex)}));S(e)}D(void 0)}}),[t,d,y,S,a,B,T,Z,_.user]),W=(0,i.useCallback)((({dragItem:e,toPosition:{sectionName:n,tileIndex:s}})=>{if(y&&t&&a&&d){let o=t,i=_.user??[];"default"!==e.fromPosition.sectionName&&([o,i]=w({dashboardState:t,pageKey:a,leafKey:d,userQueryContext:_.user||[],sectionName:e.fromPosition.sectionName,index:e.fromPosition.tileIndex})),"default"!==n&&([o,i]=K({dashboardState:o,pageKey:a,leafKey:d,userQueryContext:i||[],sectionName:n,index:s,queryContextEntry:{key:e.key,value:e.value}})),o!==t&&y(o),i!==_.user&&Z(i)}}),[t,d,y,a,Z,_.user]),$=(0,i.useCallback)((({dragItem:e,toPosition:{sectionName:t,tileIndex:a}})=>{Y(t,e.key,a)}),[Y]);return(0,n.BX)(x.ResizableEditor,{children:[(0,n.tZ)(m.m,{value:L,isSearchVisible:!0,searchPlaceholder:q({id:"aui.tool.queryContextEditor.searchContextEntries"}),onClick:M}),(0,n.tZ)(f.e,{sections:U,dragItemTypes:["QUERY_CONTEXT_ENTRY"],canDrop:({dragItem:e,toPosition:{sectionName:t}})=>"QUERY_CONTEXT_ENTRY"===e.type&&"default"!==t&&e?.fromPosition?.sectionName!==t&&!_[t]?.some((({key:t})=>t===e.key)),onTileRemoved:X,onTileMoved:W,onTileAdded:$,popoverPosition:B,popover:{content:B&&(0,n.tZ)(v,{onOk:A,templatedName:B.key,onCancel:()=>D(void 0),queryContext:_[B.sectionName]})},popoverInnerHeight:110})]})}}}]);