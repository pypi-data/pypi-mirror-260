"use strict";!function(){function uploadFiles(form,fileInput,name){var url=fileInput.getAttribute("data-url"),promises=(fileInput.loaded=0,fileInput.total=0,Array.from(fileInput.files).map(function(file){form.total+=file.size,fileInput.total+=file.size;var s3Form=new window.FormData;return Array.from(fileInput.attributes).forEach(function(attr){var name=attr.name;name.startsWith("data-fields")&&(name=name.replace("data-fields-",""),s3Form.append(name,attr.value))}),s3Form.append("success_action_status","201"),s3Form.append("Content-Type",file.type),s3Form.append("file",file),function(method,url,data,fileInput,file,form){return file.loaded=0,new Promise(function(resolve,reject){var xhr=new window.XMLHttpRequest;xhr.onload=function(){201===xhr.status?resolve(xhr.responseText):reject(xhr.statusText)},xhr.upload.onprogress=function(e){var diff=e.loaded-file.loaded,diff=(form.loaded+=diff,fileInput.loaded+=diff,file.loaded=e.loaded,{currentFile:file,currentFileName:file.name,currentFileProgress:Math.min(e.loaded/e.total,1),originalEvent:e});form.dispatchEvent(new window.CustomEvent("progress",{detail:Object.assign({progress:Math.min(form.loaded/form.total,1),loaded:form.loaded,total:form.total},diff)})),fileInput.dispatchEvent(new window.CustomEvent("progress",{detail:Object.assign({progress:Math.min(fileInput.loaded/fileInput.total,1),loaded:fileInput.loaded,total:fileInput.total},diff)}))},xhr.onerror=function(){reject(xhr.statusText)},xhr.open(method,url),xhr.send(data)})}("POST",url,s3Form,fileInput,file,form)}));Promise.all(promises).then(function(results){results.forEach(function(result){var hiddenFileInput=document.createElement("input");hiddenFileInput.type="hidden",hiddenFileInput.name=name,hiddenFileInput.value=(result=result,result=(new window.DOMParser).parseFromString(result,"text/xml").getElementsByTagName("Key")[0],decodeURI(result.childNodes[0].nodeValue)),form.appendChild(hiddenFileInput)}),fileInput.name="",--window.uploading},function(err){console.log(err),fileInput.setCustomValidity(err),fileInput.reportValidity()})}function clickSubmit(e){var e=e.currentTarget,form=e.closest("form"),submitInput=document.createElement("input");submitInput.type="hidden",submitInput.value=e.value||"1",submitInput.name=e.name,form.appendChild(submitInput)}function uploadS3Inputs(form){window.uploading=0,form.loaded=0,form.total=0;var inputs=Array.from(form.querySelectorAll("input[type=file].s3file"));inputs.forEach(function(input){var hiddenS3Input=document.createElement("input"),hiddenS3Input=(hiddenS3Input.type="hidden",hiddenS3Input.name="s3file",hiddenS3Input.value=input.name,form.appendChild(hiddenS3Input),document.createElement("input"));hiddenS3Input.type="hidden",hiddenS3Input.name=input.name+"-s3f-signature",hiddenS3Input.value=input.dataset.s3fSignature,form.appendChild(hiddenS3Input)}),inputs.forEach(function(input){window.uploading+=1,uploadFiles(form,input,input.name)}),function waitForAllFiles(form){0!==window.uploading?setTimeout(function(){waitForAllFiles(form)},100):window.HTMLFormElement.prototype.submit.call(form)}(form)}document.addEventListener("DOMContentLoaded",function(){var forms=Array.from(document.querySelectorAll("input[type=file].s3file")).map(function(input){return input.closest("form")});(forms=new Set(forms)).forEach(function(form){form.addEventListener("submit",function(e){e.preventDefault(),uploadS3Inputs(e.target)});form=form.querySelectorAll("input[type=submit], button[type=submit]");Array.from(form).forEach(function(submitButton){submitButton.addEventListener("click",clickSubmit)})})})}();