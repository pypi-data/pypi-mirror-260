! This an autogenerated file
! Please do not edit. 
! user defined code can be added at the marked locations.
!------------------------------------------------------------------------------
!******************************************************************************
module {{type.module}}
    !******************************************************************************
    !using general modules
    use class_string
    use, intrinsic :: iso_fortran_env, only: dp => real64
    use string_util
    use h5accessor_f
    use iso_c_binding, only: c_null_char, c_char
    use exceptions, only: throw, exception_occurred
    use class_io_exception, only: io_exception
    use class_illegal_state_exception, only: illegal_state_exception
    !******************************************************************************
{%- for dependency in type.dependencies %}
    use {{dependency.module}}, only: {{dependency.type}}
{%- endfor %}
#   include "exceptions.h"
    !---------------------------------------------------------------------------
!@@@@@ USER DEFINED USE START @@@@@
{{type.user_defined.get("use", "")}}
!@@@@@ USER DEFINED USE END @@@@@
    !---------------------------------------------------------------------------
    implicit none
    private
    !---------------------------------------------------------------------------
    public :: {{type.type}}
    !> {{type.description}}
    type :: {{type.type}}
        private
{%- for attr in type.attributes %}
        !> {{attr.description}}
        {{attr.type_init}}
{%- endfor %}
!@@@@@ USER DEFINED PROPERTIES START @@@@@
{{type.user_defined.get("properties", "")}}
!@@@@@ USER DEFINED PROPERTIES END @@@@@
    contains
        private

        generic, public :: default_init => default_initFromSingle, default_initFromSingleWiNameFromChar, default_initFromSingleWiNameFromString
        generic, public :: save_hdf5 => save_hdf5_filename, save_hdf5_filename_name, save_hdf5_group_id
        generic, public :: load_HDF5 => load_HDF5_fromDefaultFile, load_HDF5_fromFileNameAndEntityName, load_HDF5_fromGroupIndex
        procedure, public :: isValid
        procedure, public :: destroy
        
        ! Private procedures
        procedure :: default_initFromSingle
        procedure :: default_initFromSingleWiNameFromChar
        procedure :: default_initFromSingleWiNameFromString
        procedure :: save_hdf5_filename
        procedure :: save_hdf5_filename_name
        procedure :: save_hdf5_group_id
        procedure :: load_HDF5_fromDefaultFile
        procedure :: load_HDF5_fromFileNameAndEntityName
        procedure :: load_HDF5_fromGroupIndex
        {%- for attr in type.attributes if attr.is_destroyable %}
        procedure :: destroy_{{attr.name}}
        {%- endfor %}
    !---------------------------------------------------------------------------
!@@@@@ USER DEFINED PROCEDURE DECLARATIONS START @@@@@
{{type.user_defined.get("procedure", "")}}
!@@@@@ USER DEFINED PROCEDURE DECLARATIONS End   @@@@@
    end type {{type.type}}
    
contains
!@@@@@ USER DEFINED DECLARATIONS START @@@@@
{{type.user_defined.get("declarations", "")}}
!@@@@@ USER DEFINED DECLARATIONS END @@@@@
    pure subroutine destroy(this)
        class({{type.type}}), intent(inout) :: this
        {%- for attr in type.attributes if attr.is_destroyable%}
        call this%destroy_{{attr.name}}()
        {%- endfor %}
    end subroutine destroy

    {%for attr in type.attributes if attr.is_destroyable %}
    pure subroutine destroy_{{attr.name}}(this)
        class({{type.type}}), intent(inout) :: this
        call this%{{attr.name}}%destroy()
    end subroutine destroy_{{attr.name}}

    {%endfor %}

    !-------------------------------Default initialization----------------------
    pure subroutine default_initFromSingleWiNameFromChar(this, insName)
        class({{type.type}}), intent(inout) :: this
        character(*), intent(in) :: insName
        
        call this%default_initFromSingle()
        ! Set the default name of the object
        this%name = string(insName)
    end subroutine default_initFromSingleWiNameFromChar
    
    pure subroutine default_initFromSingleWiNameFromString(this, insName)
        class({{type.type}}), intent(inout) :: this
        type(String), intent(in) :: insName
        
        call this%default_initFromSingle()
        ! Set the default name of the object
        this%name = insName
    end subroutine default_initFromSingleWiNameFromString

    pure subroutine default_initFromSingle(this)
        class({{type.type}}), intent(inout) :: this
        
        {%-if type.has_name%} 
		! Set the default name of the object
		this%name = string('{{type.type}}')
	    {%-endif%} 
        {%-for attr in type.attributes if attr.has_default_init %}
        call this%{{attr.fieldname}}%default_init('{{attr.name}}')
        {%-endfor%}
    end subroutine default_initFromSingle

    subroutine save_hdf5_filename(this, filename, overwrite)
        implicit none
        class({{type.type}}) :: this
        !> Name of file to store object in
        type(string), intent(in) :: filename
        !> Erase data from existing file before writing new? Default: False
        logical, optional, intent(in) :: overwrite
        
        call this%save_hdf5(filename, this%name, overwrite)
        if (exception_occurred()) return
    end subroutine


    subroutine save_hdf5_filename_name(this, filename, name, overwrite)
        implicit none
        class({{type.type}}) :: this
        !> Name of file to store object in
        type(string), intent(in) :: filename
        !> Name of object on file
        type(string), intent(in) :: name
        !> Erase data from existing file before writing new? Default: False
        logical, optional, intent(in) :: overwrite
        ! Internal variables
        type(string) :: error_message
        logical :: exists
        logical :: is_overwrite
        integer :: dataBaseID, groupID, errorj
        integer :: i, n
        character(kind=c_char), allocatable :: cchars(:)
        character(len=:), allocatable :: fileFormat
        
        is_overwrite = .false.
        if (present(overwrite)) is_overwrite = overwrite
        
        if (.not. this%isValid()) then
            error_message = 'Cannot save model that is not valid'
            call throw(illegal_state_exception(error_message))
            end if
        ! Initialization
        errorj=0
        call h5a_initialize('no config required')
        
                inquire(file=filename%to_chars(), exist=exists)
        if (exists .and. is_overwrite) then
            errorj = H5A_RemoveDatabase(filename%to_c_chars())
            if (H5A_IS_ERROR(errorj)) then
                error_message = 'Failed to remove existing file ' + filename
                call throw(io_exception(error_message))
                return
            end if
        end if
        
        dataBaseID = H5A_OpenOrCreateDatabase(filename%to_c_chars())
        if (H5A_IS_ERROR(dataBaseID)) then
            error_message = 'Failed to create file ' + filename
            call throw(io_exception(error_message))
            return
        end if
        
        ! Save the current object
        if (.not. exists .or. is_overwrite) then
            ! Specify file format
            errorj = H5A_SetFormat(dataBaseID, 'simos_r0' // c_null_char)
            if (H5A_IS_ERROR(errorj)) then
                error_message = 'Failed to set format of file'
                call throw(io_exception(error_message))
                return
            end if
        else
            ! Verify format
            errorj = H5A_GetFormatSize(dataBaseID, n)
            if (.not. H5A_IS_ERROR(errorj)) then
                allocate(cchars(n))
                allocate(character(len=n) :: fileFormat)
                errorj = H5A_GetFormat(dataBaseID, cchars)
                if (.not. H5A_IS_ERROR(errorj)) then
                    do i = 1, n
                        fileFormat(i:i) = cchars(i)
                        ! Replace any newline or null characters with whitespace so that they may be trimmed away (kind of hacky)
                        if (cchars(i) == new_line(cchars) .or. cchars(i) == c_null_char) then
                            fileFormat(i:i) = ' '
                        end if
                    end do
                    if (trim(fileFormat) /= 'simos_r0') then
                        error_message = "Cannot read file with format '" // fileFormat // "', " //       &
                                        "only 'simos_r0' is supported. Error during read of file " // fileName%toChars()
                        call throw(io_exception(error_message))
                        goto 8000
                    end if
                end if
            end if
        end if
        groupID = H5A_CreateEntity(dataBaseID, name%to_c_chars())
        if (H5A_IS_ERROR(groupID)) then
            error_message = 'Failed to create entity ' + name + ' in file ' + filename
            call throw(io_exception(error_message))
            return
        end if
        call this%save_hdf5(groupID)
        errorj=H5A_CloseEntity(groupID)
        
        ! Close the data base
        8000 continue
        errorj = H5A_CloseDatabase(dataBaseID)
        if (H5A_IS_ERROR(groupID)) then
            error_message = 'Failed to close file ' + filename
            call throw(io_exception(error_message))
            return
        end if
    end subroutine
    

    subroutine save_hdf5_group_id(this,groupIndex)
        implicit none
        class({{type.type}}) :: this
        integer, intent(in) :: groupIndex
        ! Internal variables
        integer :: errorj
        type(string) :: error_message
        type(string) :: str
        integer :: sv
        integer, dimension(:), allocatable :: diml
        integer :: subGroupIndex
        
        ! Some initializations
        errorj=0
        
        ! Save the class of the object
        errorj=h5a_setType(groupIndex,'{{type.path}}' // c_null_char)
        if (H5A_IS_ERROR(errorj)) then
            error_message = 'Error during saving of {{type.path}}'
            call throw(io_exception(error_message))
            return
        end if
        
        {%for attr in type.attributes %}
        !-------------------------------------------------------------------------
        ! Save property {{attr.name}}
        !-------------------------------------------------------------------------
        {{attr.save_hdf5}}
        {%endfor %}

        ! Set properties order
        {{type.hdf5_save_order}}
        
        if (H5A_IS_ERROR(errorj)) then
            error_message = 'Error during saving to hdf5 file'
            call throw(io_exception(error_message))
            return
        end if
    end subroutine

    !-----------------------------  Load  --------------------------------------
    subroutine load_HDF5_fromDefaultFile(this)
        implicit none
        class(Body) :: this
        !Internal variables, for proper cloning 
        type(String) :: fileName
        type(String) :: name
        
        name = this%name   !has to be cloned before loading
        fileName = name%toChars()+'.h5'
        call this%load_HDF5(fileName, name)
    end subroutine load_HDF5_fromDefaultFile
    
    !---------------------------------------------------------------------------
    
    subroutine load_HDF5_fromFileNameAndEntityName(this, fileName, entityName)
        implicit none
        class(Body) :: this
        type(String), intent(in) :: fileName
        type(String), intent(in) :: entityName
        ! Internal variables
        logical :: there
        type(string) :: error_message
        integer :: dataBaseID, groupID, error
        integer :: i
        integer :: n
        character(kind=c_char), allocatable :: cchars(:)
        character(len=:), allocatable :: fileFormat
        
        ! Initialization
        call h5a_initialize('no config required')
        
        ! Open database file if present
        inquire(file=fileName%toChars(), exist=there)
        if (there) then
            call this%destroy()
            dataBaseID = H5A_OpenDatabaseReadOnly(fileName%toChars() // c_null_char)
            if (H5A_IS_ERROR(dataBaseID)) then
                error_message = 'Unable to open file ' // fileName%toChars() // ' for reading'
                call throw(io_exception(error_message))
                return
            end if
        else
            error_message = 'HDF5 file not found: ' // fileName%toChars()
            call throw(io_exception(error_message))
            return
        end if
        
        ! Check format attribute
        error = H5A_GetFormatSize(dataBaseID, n)
        if (.not. H5A_IS_ERROR(error)) then
            allocate(cchars(n))
            allocate(character(len=n) :: fileFormat)
            error = H5A_GetFormat(dataBaseID, cchars)
            if (.not. H5A_IS_ERROR(error)) then
                do i = 1, n
                    fileFormat(i:i) = cchars(i)
                    ! Replace any newline or null characters with whitespace so that they may be trimmed away (kind of hacky)
                    if (cchars(i) == new_line(cchars) .or. cchars(i) == c_null_char) then
                        fileFormat(i:i) = ' '
                    end if
                end do
                if (trim(fileFormat) /= 'simos_r0') then
                    error_message = "Cannot read file with format '" // fileFormat // "', " //       &
                                    "only 'simos_r0' is supported. Error during read of file " // fileName%toChars()
                    call throw(io_exception(error_message))
                    goto 8000
                end if
            end if
        end if
        if (H5A_IS_ERROR(error)) then
            error_message = 'Error determining format of file ' // fileName%toChars()
            call throw(io_exception(error_message))
            goto 8000
        end if
        
        ! Get the first groupIndex and load the object
        groupID = H5A_OpenEntity(dataBaseID, entityName%toChars() // c_null_char)
        this%name = entityName
        if (.not. H5A_IS_ERROR(groupID)) then
            call this%load_HDF5(groupID)
            error=H5A_CloseEntity(groupID)
            if (exception_occurred()) goto 8000
        else
            error_message = 'Group not found: ' // entityName%toChars()
            call throw(io_exception(error_message))
            goto 8000
        end if
        
        ! Finally - close the database
        8000 continue
        error = H5A_CloseDatabase(dataBaseID)
        ! Silently ignore any error during close
    end subroutine load_HDF5_fromFileNameAndEntityName
    
    !---------------------------------------------------------------------------
    
    subroutine load_HDF5_fromGroupIndex(this, groupIndex)
        implicit none
        class(Body) :: this
        integer, intent(in) :: groupIndex
        ! Internal variables
        type(string) :: error_message
        integer :: error
        integer :: sv
        integer, dimension(:), allocatable :: diml
        integer :: strSize
        character(kind=c_char), allocatable :: cc_a(:)
        integer :: subGroupIndex
        
        ! Some initializations
        error=0
        
        {%for attr in type.attributes %}
        !-------------------------------------------------------------------------
        ! Load property {{attr.name}}
        !-------------------------------------------------------------------------
        {{attr.load_hdf5}}
        {%endfor %}
       
    end subroutine load_HDF5_fromGroupIndex

    !-------------------------------Is valid -----------------------------------
    logical elemental function isValid(this)
        class({{type.type}}), intent(in) :: this
        isValid = .true.
         {%-if type.has_name%} 
        if (this%name%isEmpty()) isValid = .false.
	    {%-endif%} 
        {%-for attr in type.attributes if attr.has_default_init %}
        if(.not. this%{{attr.fieldname}}%isValid()) isValid = .false.
        {%-endfor%}
    end function

!@@@@@ USER DEFINED PROCEDURES START @@@@@
{{type.user_defined.get("procedures", "")}}
!@@@@@ USER DEFINED PROCEDURES END @@@@@

end module {{type.module}}